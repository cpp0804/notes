## 参考博文
[基本功：线程上下文切换](https://blog.csdn.net/alex_xfboy/article/details/90722654)
[java线程上下文切换，用于理解java程序cpu损耗分析](https://blog.csdn.net/jack_shuai/article/details/108352985)
[上下文切换](https://blog.csdn.net/weixin_45853533/article/details/113250667?utm_term=%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2%E7%9A%84%E6%B5%81%E7%A8%8B&utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~all~sobaiduweb~default-4-113250667&spm=3001.4430)


[TOC]

# 概念
在多任务处理系统中，CPU需要处理所有程序的操作，当用户来回切换它们时，需要记录这些程序执行到哪里

上下文 是指某一时间点 CPU 寄存器和程序计数器的内容

上下文切换（有时也称做进程切换或任务切换）是指CPU从一个进程或线程切换到另一个进程或线程。

步骤：
1. 挂起当前任务（线程/进程），将这个任务在 CPU 中的状态（上下文）存储于内存中的某处
2. 恢复一个任务（线程/进程），在内存中检索下一个任务的上下文并将其在 CPU 的寄存器中恢复
3. 跳转到程序计数器所指向的位置（即跳转到任务被中断时的代码行），以恢复该进程在程序中



# 切换种类
上下文切换种类|	描述|
--|--|
线程切换	|同一进程中的两个线程之间的切换
进程切换	|两个进程之间的切换
模式切换	|在给定线程中，用户模式和内核模式的切换
地址空间切换	|将虚拟内存切换到物理内存

## 进程
进程的上下文切换过程：
(a).接收到切换信号，挂起进程，记录当前进程的虚拟内存、栈等资源存储;
(b).将这个进程在 CPU 中的上下文状态存储于起来;
(c).然后在内存中检索下一个进程的上下文;
(d).并将其加载到 CPU的寄存器中恢复;
(e).还需要刷新进程的虚拟内存和用户栈;
(f).最后跳转到程序计数器所指向的位置（即跳转到进程被中断时的代码行），以恢复该进程。


下列将会触发进程上下文切换的场景：
(a).根据调度策略，将CPU时间划片为对应的时间片，当时间片耗尽，当前进程必须挂起。
(b).资源不足的(如内存不足)，在获取到足够资源之前进程挂起。
(c).进程sleep挂起进程。
(d).高优先级进程导致当前进程挂起
(e).硬件中断，导致当前进程挂起

## 线程
1).当进程只有一个线程时,我们可以认为进程就是线程
2).当进程中有多个线程时,这些线程会共享相同的虚拟内存和全局变量等资源,这些资源在同一个进程中的线程上下文切换时是不需要修改的
3).线程也有自己的私有数据, 比如栈和寄存器等,这些在进行上下文切换时是需要保存的


线程上下文切换分为两种情况:
1).两个线程不属于同一进程, 这种情况上下文切换和进程的上下文切换是一样的 
2).同一进程中的线程间切换, 由于同属于一个进程, 所以切换时虚拟内存和全局变量等共享资源保持不动, 只需要切换线程的私有数据等不共享的数据

可能引起线程调度(上下文切换)的原因：
1. 当前线程时间片用完，CPU调度下一线程
2. 当前线程阻塞，调度器将线程挂起
3. 当前线程中断了

由于多线程有上下文的切换过程，所以多线程执行不一定要比串行执行块



# 切换查看
Linux系统下可以使用vmstat命令来查看上下文切换的次数， 其中cs列就是指上下文切换的数目（一般情况下, 空闲系统的上下文切换每秒大概在1500以下）


# 优化手段
1. 无锁并发编程，多线程处理数据时，可以用一些办法来避免使用锁，如将数据的ID按照Hash取模分段，不同的线程处理不同段的数据
3. CAS算法，Java的Atomic包使用CAS算法来更新数据，而不需要加锁
4. 使用最少线程,避免创建不需要的线程，比如任务很少，但是创建了很多线程来处理，这样会造成大量线程都处于等待状态
5. 协程，单线程里实现多任务的调度，并在单线程里维持多个任务间的切换